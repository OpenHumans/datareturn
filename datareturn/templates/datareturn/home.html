{% extends 'base.html' %}

{% load markdown_deux_tags %}

{% block content %}
{% if user.is_authenticated %}
  <p><b>Account: {{ user.email }}</b></p>

  {% if user.is_staff %}
    <p>
      This is an admin account.
    </p>

    <a class="btn btn-primary"
        href="{% url 'admin:index' %}">
      Go to admin page
    </a>
  {# Not staff. #}
  {% else %}
    <h3>Data from {{ site.siteconfig.source_name }}</h3>
    {% if site.siteconfig.data_page_intro %}
    {{ site.siteconfig.data_page_intro|markdown }}
    {% else %}
    <p>Thank you for participating in {{ site.siteconfig.source_name }}!</p>
    <p>
      We're sharing with you copies of the raw data we generated from
      your contributribution. These could be large and/or highly technical data
      files. It's possible that you won't be able to personally inspect or
      interpret these files yourself, but we want to give you access to your
      raw data generated by our study.
    </p>
    {% endif %}
    <hr>
    <h4>Export to Open Humans</h4>
    {% if site.siteconfig.data_page_open_humans %}
    {{ site.siteconfig.data_page_open_humans|markdown }}
    {% else %}
    <p>
      We're also giving you the ability to export this data to
      <a href="https://www.openhumans.org">Open Humans</a>. This is entirely
      optional.
    </p>
    <p>
      Open Humans is a free nonprofit project that enables members to aggregate
      their data from studies and other sources, and share their data with
      others.
    </p>
    <p>
      New research studies will be able to invite you to share your data with
      them. You can even <a href="https://www.openhumans.org/public-data/">"Open
      source" your data</a> by publicly sharing it. Open Humans also notifies
      members about new interesting studies, shares updates about those studies,
      and is a community where study participants can meet each other and talk
      about the studies they contribute to.
    </p>
    {% endif %}
    {% if user.datafile_set.all or user.datalink_set.all %}
      {% if not request.user.openhumansuser.is_connected %}
      <p>
        Click the link below to start the data export process to an Open
        Humans account.
      </p>
      <a class="btn btn-md btn-primary" href="{{ site.openhumansconfig.auth_url }}">
        Export data to Open Humans
      </a>
      {% else %}
      <p>Congrats! Your data is connected to Open Humans.</p>
      <p>
        <small>You can remove this connection on your
          <a href="{{ site.openhumansconfig.removal_url }}">
            Open Humans connections page</a>.</small>
      </p>
      {% endif %}
    {% else %}
      <p>
        <b>Export not available:</b> Sorry, it seems that there's no data is
        available to export!
      </p>
    {% endif %}
    {% if user.datafile_set.all %}
    <hr>
    <h4>Your data</h4>
    {% if site.siteconfig.data_page_data_section %}
    {{ site.siteconfig.data_page_data_section|markdown }}
    {% endif %}
    <h5>Data files</h5>
    <table class="table table-hover">
      <thead>
        <tr>
          <th>File</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        {% for datafile in user.datafile_set.all %}
        <tr>
          <td>
            <a href="{{ datafile.datafile.url }}">
              {{ datafile.basename }}
            </a>
          </td>
          <td>
            {{ datafile.description }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
    {% if user.datalink_set.all %}
    <h5>Data links</h4>
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Link</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        {% for datalink in user.datalink_set.all %}
        <tr>
          <td>
            <a href="{{ datalink.url }}">
              {{ datalink.name }}
            </a>
          </td>
          <td>
            {{ datalink.description }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
    {% if not user.datafile_set.all and not user.datalink_set.all %}
      <p>
        Sorry, no data seems to be loaded to this account!
      </p>
    {% endif %}
  {% endif %}

{# Not authenticated. #}
{% else %}
<p>
  Welcome to our data return site.
<p>If we've returned data to you, you can access it by logging in
  <a href="{% url 'account_reset_password' %}">with a login link</a>.
</p>
<a class="btn btn-lg btn-primary" href="{% url 'account_reset_password' %}"
    style="margin-top:10px">
  Get a login link</a>

{% endif %}

{% endblock %}
